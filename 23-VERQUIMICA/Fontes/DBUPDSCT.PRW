#INCLUDE "PROTHEUS.CH"
#INCLUDE "TOPCONN.CH"

#DEFINE CRLF CHR(13)+CHR(10)

USER FUNCTION DBUPDSCT() 

IF	MSGYESNO("Esta rotina serve para reordenar todos os registros da tabela SCT, deseja reordenar os registros?")	
	PROCESSA( { || VQUPDSCT() }, "Processando", "Atualizando SCT...")
ENDIF

RETURN()

STATIC FUNCTION VQUPDSCT()
LOCAL _CQUERY 	:= ""  
LOCAL _CDOCSEQ 	:= 1000	// NUMERO
LOCAL _NSEQREG 	:= 1 	// SEQUENCIA
LOCAL _CCODCLI 	:= ""
LOCAL _CLOJCLI	:= ""        
LOCAL _CMSG		:= ""
LOCAL _NQTDREG	:= 0

DBSELECTAREA("SCT");DBSETORDER(1)
/*  
_CQUERY := " SELECT 		" + CRLF
_CQUERY += " *				" + CRLF
_CQUERY += " FROM SCT010	" + CRLF
_CQUERY += "	WHERE 		" + CRLF
_CQUERY += "		D_E_L_E_T_ <> '*'	" + CRLF
//_CQUERY += "	AND	CT_CLIENTE IN ('C00013','C00014','C00015','C00016')	" + CRLF
_CQUERY += " ORDER BY CT_CLIENTE, CT_LOJA, CT_REGIAO, CT_GRPCLI	" + CRLF 
*/

_CQUERY := " SELECT * FROM ( " + CRLF
_CQUERY += "  SELECT " + CRLF
_CQUERY += "   CT_CLIENTE,  " + CRLF
_CQUERY += "   CT_LOJA, " + CRLF
_CQUERY += "   CT_GRUPO, " + CRLF
_CQUERY += "   COUNT(CT_GRUPO) 	AS QTDE_GRUPO, " + CRLF
_CQUERY += "   AVG(CT_QUANT) 	AS MEDIA_QTDE_CONS, " + CRLF 
_CQUERY += "   CT_NOMCLI, " + CRLF
_CQUERY += "   CT_REGIAO, " + CRLF
_CQUERY += "   CT_GRPCLI	  	" + CRLF		
_CQUERY += "  FROM SCT010	 " + CRLF
_CQUERY += " 	WHERE 		 " + CRLF
_CQUERY += " 		D_E_L_E_T_ <> '*'	 " + CRLF
_CQUERY += " GROUP BY  " + CRLF
_CQUERY += "   CT_CLIENTE, " + CRLF
_CQUERY += "   CT_LOJA,  " + CRLF
_CQUERY += "   CT_VEND, " + CRLF
_CQUERY += "   CT_REGIAO, " + CRLF
_CQUERY += "   CT_CATEGO, " + CRLF
_CQUERY += "   CT_TIPO, " + CRLF
_CQUERY += "   CT_GRUPO, " + CRLF
_CQUERY += "   CT_PRODUTO, " + CRLF
_CQUERY += "   CT_NOMCLI, " + CRLF
_CQUERY += " 	  CT_REGIAO, " + CRLF
_CQUERY += " 	  CT_GRPCLI " + CRLF
_CQUERY += " 	HAVING COUNT(CT_GRUPO) > 1 " + CRLF
_CQUERY += " 	UNION ALL  " + CRLF
_CQUERY += " 	 SELECT " + CRLF
_CQUERY += " 	  CT_CLIENTE,  " + CRLF
_CQUERY += " 	  CT_LOJA, " + CRLF
_CQUERY += " 	  CT_GRUPO, " + CRLF
_CQUERY += " 	  COUNT(CT_GRUPO) AS QTDE_GRUPO, " + CRLF
_CQUERY += " 	  AVG(CT_QUANT) AS MEDIA_QTDE_CONS, " + CRLF
_CQUERY += " 	  CT_NOMCLI, " + CRLF
_CQUERY += " 	  CT_REGIAO, " + CRLF
_CQUERY += " 	  CT_GRPCLI		 	" + CRLF	
_CQUERY += " 	 FROM SCT010	 " + CRLF
_CQUERY += " 		WHERE 		 " + CRLF
_CQUERY += " 			D_E_L_E_T_ <> '*' " + CRLF
_CQUERY += " 	GROUP BY " + CRLF
_CQUERY += " 	  CT_CLIENTE, " + CRLF
_CQUERY += " 	  CT_LOJA, " + CRLF
_CQUERY += " 	  CT_GRUPO, " + CRLF
_CQUERY += " 	  CT_NOMCLI, " + CRLF
_CQUERY += " 	  CT_REGIAO, " + CRLF
_CQUERY += " 	  CT_GRPCLI		" + CRLF
_CQUERY += " 	HAVING COUNT(CT_GRUPO) < 2 " + CRLF
_CQUERY += " 	 ) ORDER BY CT_CLIENTE, CT_LOJA, CT_GRUPO, CT_GRPCLI " + CRLF

IF SELECT( "UPDSCT") > 0
      UPDSCT->(DBCLOSEAREA())
ENDIF                       

TCQUERY _CQUERY NEW ALIAS "UPDSCT"

PROCREGUA(CONTAR("UPDSCT","!Eof()")   )      
DBSELECTAREA( "UPDSCT")  
UPDSCT->(DBGOTOP())

WHILE !UPDSCT->(EOF())		
	IF _CCODCLI <> ALLTRIM(UPDSCT->CT_CLIENTE)	.OR. _CLOJCLI <> ALLTRIM(UPDSCT->CT_LOJA)
		_CCODCLI := ALLTRIM(UPDSCT->CT_CLIENTE)      
		_CLOJCLI := ALLTRIM(UPDSCT->CT_LOJA)
	    _CDOCSEQ := _CDOCSEQ + 1
	    _NSEQREG := 1 
	ENDIF
	INCPROC("CLIENTE: "+ UPDSCT->CT_CLIENTE +"  LOJA: " + UPDSCT->CT_LOJA + " DOC/SEQ: " + STRZERO(_CDOCSEQ,9) + "/" + STRZERO(_NSEQREG,3))                       
	RECLOCK("SCT",.T.)
  		SCT->CT_FILIAL 	:= 	"01"
  		SCT->CT_DOC		:= 	STRZERO(_CDOCSEQ,9)
  		SCT->CT_SEQUEN	:= 	STRZERO(_NSEQREG,3)
  		SCT->CT_DESCRI	:= 	"IMPORTACAO VIA FUN:DBUPDSCT()"
  		SCT->CT_DATA	:=	DATE()
  		SCT->CT_CLIENTE	:=	UPDSCT->CT_CLIENTE
  		SCT->CT_LOJA	:=	UPDSCT->CT_LOJA
  		SCT->CT_VEND	:=	" "
  		SCT->CT_REGIAO	:=	UPDSCT->CT_REGIAO
  		SCT->CT_CATEGO	:=	" "
  		SCT->CT_TIPO	:=	" "
  		SCT->CT_GRUPO	:=	UPDSCT->CT_GRUPO
  		SCT->CT_PRODUTO	:=	" "
  		SCT->CT_QUANT	:=	UPDSCT->MEDIA_QTDE_CONS
  		SCT->CT_VALOR	:=	1
  		SCT->CT_MOEDA	:=	1
  		SCT->CT_CCUSTO	:=	" "
  		SCT->CT_ITEMCC	:=	" "
  		SCT->CT_CLVL	:=	" "
  		SCT->CT_NOMCLI	:=  UPDSCT->CT_NOMCLI
  		SCT->CT_GRPCLI	:=	" "
  		SCT->CT_DIVCLI	:=	" "
	MSUNLOCK()
	_NSEQREG := _NSEQREG + 1 
	_NQTDREG := _NQTDREG + 1	
	UPDSCT->(DBSKIP())               	
ENDDO                   
MSGINFO("Quantidade de Registros novos inseridos na tabela SCT : " + CVALTOCHAR(_NQTDREG), "INCLUSOES")
	
RETURN()                

USER FUNCTION DBSCTFAT()        
LOCAL _CQUERY := ""   
LOCAL _AADCSCT := {}  
LOCAL _AFAT	:= {}             
LOCAL _ASCT := {}
LOCAL _NPOS := {}

_CQUERY := " SELECT D2_CLIENTE, D2_LOJA, D2_COD, D2_QUANT, D2_GRUPO, F2_EMISSAO, A1_REGIAO, A1_GRPVEN  FROM SD2010  " + CRLF
_CQUERY += " INNER JOIN SF2010 ON (SF2010.F2_DOC = SD2010.D2_DOC)                                                       " + CRLF
_CQUERY += " INNER JOIN SA1010 ON (SD2010.D2_CLIENTE = SA1010.A1_COD AND SD2010.D2_LOJA = SA1010.A1_LOJA) " + CRLF
_CQUERY += " WHERE  " + CRLF
_CQUERY += " 	SD2010.D_E_L_E_T_ <> '*' AND " + CRLF
_CQUERY += " 	SF2010.D_E_L_E_T_ <> '*' AND " + CRLF
_CQUERY += " 	SD2010.D2_TP IN ('MP','PA') AND" + CRLF
_CQUERY += " 	SF2010.F2_EMISSAO >= '20160101' " + CRLF
//_CQUERY += " 	AND SF2010.F2_CLIENTE BETWEEN 'C00012' AND 'C00020' " + CRLF
_CQUERY += " ORDER BY  " + CRLF
_CQUERY += " 	D2_CLIENTE, D2_LOJA, F2_EMISSAO DESC, D2_COD " + CRLF

IF SELECT( "UPDSCTFAT") > 0
      UPDSCTFAT->(DBCLOSEAREA())
ENDIF                       

TCQUERY _CQUERY NEW ALIAS "UPDSCTFAT"

PROCREGUA(CONTAR("UPDSCTFAT","!Eof()")   )      
DBSELECTAREA( "UPDSCTFAT")  
UPDSCTFAT->(DBGOTOP())
	
WHILE !UPDSCTFAT->(EOF())
	_NPOS := ASCAN(_AFAT, {|X| ALLTRIM(UPPER(X[1]+X[2]+X[5])) == ALLTRIM(UPPER(UPDSCTFAT->(D2_CLIENTE+D2_LOJA+D2_GRUPO))) })		
	IF _NPOS = 0
		AADD(_AFAT, {UPDSCTFAT->D2_CLIENTE, UPDSCTFAT->D2_LOJA, UPDSCTFAT->D2_COD, UPDSCTFAT->D2_QUANT, UPDSCTFAT->D2_GRUPO, UPDSCTFAT->F2_EMISSAO, UPDSCTFAT->A1_REGIAO, UPDSCTFAT->A1_GRPVEN, 0})
	ENDIF					
 UPDSCTFAT->(DBSKIP())
ENDDO

UPDSCTFAT->(DBCLOSEAREA())  
      
DBSELECTAREA("SCT"); DBSETORDER(1)

FOR NX := 1 TO LEN(_AFAT) 
	_ASCT := {}      
	_CQUERY := " SELECT CT_CLIENTE, CT_LOJA, CT_GRUPO, CT_QUANT, CT_DESCRI, CT_DOC, CT_SEQUEN FROM SCT010 WHERE CT_CLIENTE = '"+_AFAT[NX][1]+"' AND CT_LOJA = '"+_AFAT[NX][2]+"' AND D_E_L_E_T_ <> '*'  ORDER BY CT_SEQUEN DESC " + CRLF
	IF SELECT( "UPDSCTFAT") > 0
      UPDSCTFAT->(DBCLOSEAREA())
	ENDIF                 
	      	
	TCQUERY _CQUERY NEW ALIAS "UPDSCTFAT"
	
	WHILE !UPDSCTFAT->(EOF())
		_NPOS := ASCAN(_ASCT, {|X| ALLTRIM(UPPER(X[1]+X[2]+X[3])) == ALLTRIM(UPPER(UPDSCTFAT->(CT_CLIENTE+CT_LOJA+CT_GRUPO))) }) 
		IF _NPOS == 0
			AADD(_ASCT, {UPDSCTFAT->CT_CLIENTE, UPDSCTFAT->CT_LOJA, UPDSCTFAT->CT_GRUPO, UPDSCTFAT->CT_QUANT, CT_DOC, CT_SEQUEN })
		ENDIF
	 UPDSCTFAT->(DBSKIP())
	ENDDO    
	
	IF LEN(_ASCT) > 0
		_NPOS := ASCAN(_ASCT, {|X| ALLTRIM(UPPER(X[1]+X[2]+X[3])) == ALLTRIM(UPPER(_AFAT[NX][1]+_AFAT[NX][2]+_AFAT[NX][5]))})
		IF _NPOS == 0   
			BEGIN TRANSACTION 
				DBSELECTAREA("SCT"); DBSETORDER(1)
				RECLOCK("SCT", .T.)
					SCT->CT_FILIAL 	:= "01"
					SCT->CT_DOC 	:= _ASCT[1][5]
					SCT->CT_SEQUEN 	:= STRZERO(Val(_ASCT[1][6]) + 1,3)   
					SCT->CT_DESCRI  := "INCLUSAO VIA FUN:DBSCTFAT"
					SCT->CT_DATA 	:= STOD(_AFAT[NX][6])
					SCT->CT_CLIENTE := _AFAT[NX][1]
					SCT->CT_LOJA    := _AFAT[NX][2]
					SCT->CT_GRUPO	:= _AFAT[NX][5]
					SCT->CT_QUANT	:= _AFAT[NX][4]
					SCT->CT_REGIAO  := _AFAT[NX][7]
					SCT->CT_GRPCLI  := _AFAT[NX][8]
					SCT->CT_VQ_GAUT := "A"
				MSUNLOCK()
			END TRANSACTION
		ENDIF
	ELSE   
		BEGIN TRANSACTION      
			DBSELECTAREA("SCT"); DBSETORDER(1)
			IF RECLOCK("SCT", .T.)         
				SCT->CT_FILIAL 	:= "01"
				SCT->CT_DOC 	:= GETSXENUM("SCT","CT_DOC")
				SCT->CT_SEQUEN 	:= STRZER(1,3)  
				SCT->CT_DATA 	:= STOD(_AFAT[NX][6])      
				SCT->CT_DESCRI  := "INCLUSAO VIA FUN:DBSCTFAT"
				SCT->CT_CLIENTE := _AFAT[NX][1]
				SCT->CT_LOJA    := _AFAT[NX][2]
				SCT->CT_GRUPO	:= _AFAT[NX][5]
				SCT->CT_QUANT	:= _AFAT[NX][4]
				SCT->CT_REGIAO  := _AFAT[NX][7]
				SCT->CT_GRPCLI  := _AFAT[NX][8]  
				SCT->CT_VQ_GAUT := "A"
				MSUNLOCK()    		
			ELSE 
				ROLLBACKSX8()
			ENDIF
                CONFIRMSX8()
		END TRANSACTION
	ENDIF
	
NEXT                                                                        
                                                                                                                       	
MSGINFO("OK")

RETURN()