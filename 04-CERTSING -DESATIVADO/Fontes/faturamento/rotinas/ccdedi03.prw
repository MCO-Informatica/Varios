#Include "Protheus.ch"
#Include "TopConn.ch"

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?CCDEDI03  ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Interface de Importacao dos Pedidos de Vendas do Sistema    ???
???          ?BPAG - CertiSign                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/
User Function CCDEDI03()

Local aTarget  := {}
Local aTemp    := {}
Local aSource  := {}
Local aInco	   := {}

// Inserir a FormBatch
Local ctitulo  := OemToAnsi("Importacao de Dados de Pedidos de Vendas.")
Local cDesc1   := OemToAnsi("Este programa ir? importar base de novos clientes ")
Local cDesc2   := OemToAnsi("e as Pedidos de Vendas da CertiSign para o Protheus.")

/*
???????????????????????????????????
?Chama a Interface de Clientes     ?
????????????????????????????????????*/
ImpPed(@aTemp,@aSource,@aTarget,cTitulo,cDesc1,cDesc2)		// cDirImp

Return Nil

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?IMPPED    ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Inicio do Processamento                                     ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function IMPPED(aTemp,aSource,aTarget,cTitulo,cDesc1,cDesc2,cDirImp)

Local cDirImp  := Space(30) //"c:\import\ped\new\"       // Pedidos Novos
Local cDirInc  := Space(30) //"c:\import\ped\pend\"      // Pedidos Inconsistentes
Local cDirBac  := Space(30) //"c:\import\ped\procd\"     // Backup de Pedidos de Vendas
Local cVersion := " - Vr 7.8"
Local lExecEdi := GetMv("MV_CCPFIL")
Local oDlgInt2
Local i
Local aTarget 	:= {}
Local aTemp    	:= {}
Local aSource  	:= {}
Local aInco	   	:= {}
Local ctitulo  	:= OemToAnsi("Interface de Pedidos de Vendas"+cVersion)
Local cDesc1   	:= OemToAnsi("Este programa ir? importar os novas Pedidos de Vendas")
Local cDesc2   	:= OemToAnsi("de Saida da base de dados BPag da CertiSign para o Protheus.")
Private cPerg	:= "CCP001"
Private cParNat	:= MV_PAR01 		// Natureza
Private cParBan	:= ""  				// Banco MV_PAR02

ValidPar()				// Cria os parametros
ValidPerg("CCP001")		// Cria as perguntas

Pergunte("CCP001")		// Realiza as Perguntas

cDirImp	:= Alltrim(mv_par02) + Iif(Right(mv_par02,1)!="\","\","") 	//"c:\import\ped\new\"       // Pedidos Novos
cDirInc	:= Alltrim(mv_par03) + Iif(Right(mv_par03,1)!="\","\","")	//"c:\import\ped\pend\"      // Pedidos Inconsistentes
cDirBac := Alltrim(mv_par04) + Iif(Right(mv_par04,1)!="\","\","")	//"c:\import\ped\procd\"     // Backup de Pedidos de Vendas
cDirLog := Alltrim(mv_par05) + Iif(Right(mv_par05,1)!="\","\","") 	//"c:\Import\Ped\Log\"		 // Log da transacao

/*
????????????????????????????????????????????????????
?Verifica Autorizacao para executar nesta Filial    ?
?????????????????????????????????????????????????????
*/

If !lExecEdi
	MsgStop(" Esta Filial n?o tem permiss?o para executar o EDI de Pedidos. Contacte o Administrador! ")
	Return
Endif

/*
???????????????????????????????????
?Verifica quais arquivos ira listar?
????????????????????????????????????
*/

aTemp:= Directory(Alltrim(cDirImp)+"PV*.txt")
If Empty(aTemp)
	MsgStop(" Nao existem arquivos de Pedidos a serem importados, ou Pasta Invalida! ")
	Return
Endif

/*
???????????????????????????????????????????????
?Alerta a existencia de Arquivos Inconsistentes?
?Chamada da funcao para startar o JOB          ?
????????????????????????????????????????????????*/
aIncon:= Directory(Alltrim(cDirInc)+"PV*.txt")
If !Empty(aIncon)
	MsgStop(OemToAnsi("Existem arquivos inconsistentes a serem importados, verifique."),OemToAnsi("Atencao"))
EndIf

/*
????????????????????????????????????????
?Carrega a lista de arquivos disponiveis?
?????????????????????????????????????????
*/

For i:= 1 To Len(aTemp)
	If aTemp[i,2] > 0
		AAdd(aSource,aTemp[i,1])
	EndIf
Next i

/*
????????????????????????????????????????????????????????
?Chamada do Job para a funcao Processa()                ?
?????????????????????????????????????????????????????????
*/

Private _lJob := (U_CallFunc("U_CALLJOB1"))
If _lJob
	U_ChosFile(@aSource,@aTarget)    			// p/ escolher o arquivo a importar
	Processa(aTarget,cDirImp,cDirBac,cDirInc)
EndIf

/*
????????????????????????????????????????????????????????
?Carrega os arquivos a importar e monta a Interface     ?
?????????????????????????????????????????????????????????*/
If !_lJob
	
	U_ChosFile(@aSource,@aTarget)    			// p/ escolher o arquivo a importar
	Define MsDialog oDlgInt2 From 140,171 To 304,607 Title cTitulo Pixel Of GetWndDefault()
	
	@ 006,006 To 048,210 Of oDlgInt2 Pixel
	@ 019,013 Say cDesc1 Of oDlgInt2 Size 190,10 Pixel
	@ 031,013 Say cDesc2 Of oDlgInt2 Size 190,10 Pixel
	
	Define SButton From 060,90 Type 5;
	Action (Pergunte("CCP001")) Enable OF oDlgInt2			// Exemplo
	
	Define SButton From 060,120 Type 20;					// Parametros
	Action (U_ChosFile(@aSource,@aTarget)) Enable OF oDlgInt2
	
	Define SButton From 060,150 Type 1;
	Action (oDlgInt2:End(),U_StatProc({||Processa(aTarget,cDirImp,cDirBac,cDirInc,Mv_Par01)},"Importando...")) Enable OF oDlgInt2
	
	Define SButton From 060,180 Type 2;
	Action (oDlgInt2:End()) Enable OF oDlgInt2
	
	Activate MsDialog oDlgInt2 On Move oDlgCon:Move(0.1,0.1,,,.T.) Centered
	
Endif
Return Nil


/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?PROCESSA  ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Inicio do Processamento                                     ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function Processa(aTarget,cDirImp,cDirBac,cDirInc,cParNat)

/*
????????????????????????
?Definicao das variaveis?
?????????????????????????
*/

Local aAmb		:= GetArea()
Local aCampos1	:= {}
Local aCampos2	:= {}
Local aAbort	:= {}
Local cNome		:= ''
Local cDirImp	:= Alltrim(mv_par02) + Iif(Right(mv_par02,1)!="\","\","") 	//"c:\import\ped\new\"       // Pedidos Novos
Local cDirInc	:= Alltrim(mv_par03) + Iif(Right(mv_par03,1)!="\","\","")	//"c:\import\ped\pend\"      // Pedidos Inconsistentes
Local cDirBac 	:= Alltrim(mv_par04) + Iif(Right(mv_par04,1)!="\","\","")	//"c:\import\ped\procd\"     // Backup de Pedidos de Vendas
Local cDirLog  	:= Alltrim(mv_par05) + Iif(Right(mv_par05,1)!="\","\","") 	//"c:\Import\Ped\Log\"		 // Log da transacao
Local i									// Qtd de arquivos a serem processados
Local nHandle	:= 0
Local lOk 		:= .t.
Local cErroTxt	:= ''
Private cArqTxt	:= ''
Private cArqLog	:= ''
Private _lJob	:= (U_CallFunc("U_CALLJOB1"))

If !_lJob                        // Testa se chama Job ou Nao
	U_SetProc(1,Len(aTarget))
EndIf


/*
???????????????????
?Ordena os arquivos?
????????????????????
*/

If Len(aTarget) == 0
	Return
Endif
ASort(aTarget)

/*
??????????????????
?Inicia o Processo?
???????????????????
*/

For i:= 1 To Len(aTarget)
	cArqTxt := AllTrim(aTarget[i])
	cArqLog	:= Lower(Left(cArqTxt, At(".",cArqTxt)-1))+'.log'         // 6a posicao
	If !_lJob
		U_AddProc(1,"Processando arquivo..."+cArqTxt)
	EndIf
	
	/*
	?????????????????????????????????????????????????????
	?Cria aquivo de Semaforo para impedir a importacao do?
	?mesmo arquivo por dois usuario ao mesmo tempo       ?
	??????????????????????????????????????????????????????
	*/
	
	nHandle:= FCreate(Lower(cDirLog+cArqLog))
	If nHandle >= 0            		// IF-1
		FWrite(nHandle,"Importa??o Iniciada em: "+Dtoc(Date())+" as: "+Time()+" por: "+Subs(cUsuario,7,6)+Chr(13)+Chr(10))
		FWrite(nHandle, "==================================================================================================="+Chr(13)+Chr(10))
		
		/*
		???????????????????????????????????????????????????????????????????
		?Verifica se foram informados: Banco e Natureza dos Pedidos        ?
		????????????????????????????????????????????????????????????????????
		*/
		
		If Empty(cParNat)
			cErroTxt := "- Arquivo de Importa??o: "+cArqTxt+" - N?o Informado a Natureza no parametro do processo."
			U_MakeTxt(nHandle,cArqLog,cErroTxt)
			Return Nil
		Endif
		
		
		/*
		???????????????????????????????????????????????????????????????????
		?Verifica se o arquivo existe na pasta para iniciar a importacao   ?
		????????????????????????????????????????????????????????????????????
		*/
		cArqTxt := Alltrim(cArqTxt)
		If File(cDirImp+cArqTxt)
			
			/*
			???????????????????????????????????????????????
			?Gera arquivo de trabalho, appendando para DBF ?
			????????????????????????????????????????????????
			*/
			
			If MakeFile(cDirImp,@cNome,cParNat)
				
				/*
				???????????????????????????
				?Valida arquivo de trabalho?
				????????????????????????????
				*/
				

				If !ValFile(cNome,cArqTxt,nHandle,cArqLog)
										/*
					????????????????????????????
					?Importa arquivo de trabalho?
					?????????????????????????????*/
					lOk:= ImportPV(cNome)
					
					
					/*
					??????????????????????????????????????????????????????
					?Move o arquivo para area de Backup qdo bem sucedido  ?
					???????????????????????????????????????????????????????*/
					If lOk
						If File(cDirImp+cArqTxt)
							Copy File (cDirImp+cArqTxt) To (cDirBac+cArqTxt)
						EndIf
						FClose(nHandle)
						FErase(cDirLog+cArqLog)			// apaga arquivo de Log
					Else
						If !File(cDirInc+cArqTxt)
							Copy File (cDirImp+cArqTxt) To (cDirInc+cArqTxt)
						EndIf
					Endif
					FErase(cDirImp+cArqTxt)			// apaga apenas o TXT
					
					/*
					????????????????????????????????
					?Finaliza o arquivo de trabalho?
					????????????????????????????????*/
					If Select("TRB") > 0
						TRB->(dbCloseArea())
					EndIf
					FErase(cNome+GetDbExtension())
					FErase(cNome+OrdBagExt())
				Else
					/*
					??????????????????????????????????????????????????
					?Copia o arquivo Txt para a area de Inconformidade?
					???????????????????????????????????????????????????*/
					cErroTxt := "- Arquivo de Importacao: "+cArqTxt+" - Recusado, todos registros inconsistentes"
					U_MakeTxt(nHandle,cArqLog,cErroTxt)
					If File(cDirImp+cArqTxt)
						
						/*
						?????????????????????????????????
						?Verifica se o arquivo ja existe?
						?????????????????????????????????
						*/
						
						If !File(cDirInc+cArqTxt)
							Copy File (cDirImp+cArqTxt) To (cDirInc+cArqTxt)
						EndIf
						FErase(cDirImp+cArqTxt)
					EndIf
					
				EndIf
				
			EndIf
			
		EndIf
		
		/*
		?????????????????????????????????????????????????
		?Deixa o Log para futura auditoria do Usuario    ?
		??????????????????????????????????????????????????
		*/
		
		FClose(nHandle)
		
	EndIf
	
Next

/*
???????????????????????
?Restaura o Ambiente   ?
????????????????????????
*/

SM0->(dbSetOrder(1))
RestArea(aAmb)
Return Nil


/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?MAKEFILE  ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Gera o arquivo de trabalho conforme a literal do arquivo    ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function MakeFile(cDirImp,cNome,cParNat)

Local aStru		:= {}
Local aCondPag	:= {}
Local cCnpj		:= ''
Local cCnpjEnt	:= ''
Local cCliEnt 	:= ''
Local cLojEnt	:= ''
Local cQuery 	:= ''
Local lRet 		:= .F.
If !_lJob
	U_AddProc(1,"Gerando arquivo Temporario..."+cArqTxt)
EndIf

/*
???????????????????????????????????????
?Montando Array Condicoes de Pagamento ?
????????????????????????????????????????
*/

If Select("QryE4") > 0
	QryE4->(dbCloseArea())
EndIf

DbSelectArea("SE4")
DbSetOrder(1)
cQuery := "SELECT E4_PGBPAG, E4_CODIGO FROM "+RetSqlName("SE4")
cQuery += " WHERE E4_FILIAL = '"+xFilial("SE4")+"' AND "
cQuery += "  	  D_E_L_E_T_ = ' ' AND E4_EDIPED IN ('2','3') "
cQuery += "       ORDER BY E4_PGBPAG"

cQuery := ChangeQuery(cQuery)
TcQuery cQuery NEW ALIAS "QryE4"

DbSelectArea("QryE4")
If QryE4->(Eof())
	MsgStop(" Atencao! N?o temos definido as Condi??es de Pagamento neste ambiente. ")
	Return lRet
Endif
DbGoTop()
While !Eof()
	Aadd(aCondPag, {E4_PGBPAG, E4_CODIGO})
	QryE4->(DbSkip())
Enddo

/*
????????????????????????????????????????????????????????????????????????
?Cria estrutura temporaria para importar as Notas Fiscais               ?
?????????????????????????????????????????????????????????????????????????
*/

Aadd(aStru,{"NUMPED"   	, "C", 09, 0 })		   	// Numero do Pedidos
Aadd(aStru,{"EMISSA"  	, "C", 08, 0 }) 	   	// Data Emissao
Aadd(aStru,{"PRODUT"	, "C", 18, 0 })	    	// Codigo Produto
Aadd(aStru,{"DESCRI"	, "C",300, 0 })	    	// Descricao do Produto
Aadd(aStru,{"QTDVEN"	, "C", 38, 0 })		   	// Qtd Vendida
Aadd(aStru,{"PRCVEN"	, "C", 38, 0 })		   	// Preco de Venda
Aadd(aStru,{"ENTREG"	, "D", 08, 0 })		   	// Data de Entrega
Aadd(aStru,{"CNPJ"		, "C", 14, 0 })		   	// Codigo Cliente
Aadd(aStru,{"CARTAO"	, "C", 01, 0 })		   	// Bandeira Cartao
Aadd(aStru,{"PAGTO"		, "C", 20, 0 })		   	// Forma Pagamento
Aadd(aStru,{"PARCELA"	, "C", 02, 0 })		   	// Parcelas
Aadd(aStru,{"CNPJENT"	, "C", 14, 0 })		   	// Codigo Cliente de Entrega
//------------------------------------------------ Colunas novas
Aadd(aStru,{"CODCAR"	, "C", 20, 0 })	    	// Cod Cartao de Credito
Aadd(aStru,{"BANDEI"	, "C", 51, 0 })	    	// Bandeira     
Aadd(aStru,{"VALIDA"	, "C",  7, 0 })	    	// Cod Seguranca
Aadd(aStru,{"CODAUT"	, "C", 20, 0 })	    	// Cod Autorizacap
//------------------------------------------------ Fora da Estrutura Txt
Aadd(aStru,{"CODSEG"	, "C",  7, 0 })	    	// Cod Seguranca
Aadd(aStru,{"PARCEL"	, "C",  2, 0 })	    	// Cod Seguranca
Aadd(aStru,{"CLIENTE"	, "C" , 06, 0 })		   	// Codigo Cliente
Aadd(aStru,{"LOJA"		, "C", 02, 0 })		   	// Codigo Cliente
Aadd(aStru,{"CLI_ENT"	, "C", 06, 0 })		   	// Codigo Cliente
Aadd(aStru,{"LOJ_ENT"	, "C", 02, 0 })		   	// Codigo Cliente
Aadd(aStru,{"BLOQUEI"	, "L", 01, 0 })			// Cliente Bloqueado ?
Aadd(aStru,{"CONDPAG"	, "C", 03, 0 })	    	// Condicao Pagamento
Aadd(aStru,{"NATURE"	, "C", 10, 0 })	    	// Natureza
Aadd(aStru,{"BANCO"		, "C", 03, 0 })	    	// Banco
Aadd(aStru,{"LOCPAD"	, "C", 02, 0 })	    	// Almoxarifado do Produto
Aadd(aStru,{"UNIDAD"	, "C", 02, 0 })	    	// Unidade Medida Produto
Aadd(aStru,{"VENDAS"	, "C", 06, 0 })	    	// Codigo Vendedor
Aadd(aStru,{"TOTITEM"	, "N", 14, 2 })		   	// Total do Item
Aadd(aStru,{"CODTES"	, "C", 03, 0 })		   	// Codigo do TES
Aadd(aStru,{"IMPORT"	, "L", 01, 0 })			// Flag Importacao
Aadd(aStru,{"MENNOTA"	, "C",250, 0 })	    	// Mensagem na NF
                       
/*
???????????????????????????
?Cria o arquivo de trabalho?
????????????????????????????*/
If Select("TRB") > 0
	TRB->(dbCloseArea())
EndIf
cNome :=CriaTrab(aStru,.t.)
DbUseArea(.t.,,cNome,"TRB",.t.,.f.)
Append From &(Lower(cDirImp+cArqTxt)) SDF

/*
??????????????????????????????????????????
?Consiste dados do Arquivo Temporario SC* ?
???????????????????????????????????????????
*/

DbGoTop()
While !eof()
	cCnpj 	:= CheckCgc(Alltrim(TRB->CNPJ))
	cCnpjEnt	:= CheckCgc(Alltrim(TRB->CNPJENT))
	
	If !Empty(TRB->CNPJENT)
		DbSelectArea("SA1")
		SA1->(dbSetOrder(3))
		DbSeek(xFilial("SA1")+U_CSFMTSA1(cCnpjEnt),.f.)
		cCliEnt 	:= if(!SA1->(Eof()), SA1->A1_COD , "")
		cLojEnt	    := if(!SA1->(Eof()), SA1->A1_LOJA, "")
	Endif
	DbSelectArea("SA1")
	SA1->(dbSetOrder(3))
	DbSeek(xFilial("SA1")+U_CSFMTSA1(cCnpj),.f.)
	cCodCli := if(!SA1->(Eof()), SA1->A1_COD , "")
	cLojaCli:= if(!SA1->(Eof()), SA1->A1_LOJA, "")
	
	aRetBand := Bandeira(TRB->BANDEI)
	//cCodCard := TRB->CLIENTE + TRB->LOJA + TRB->CLI_ENT + TRB->LOJ_ENT
	cParcela := TRB->PARCELA
	
	DbSelectArea("TRB")
	RecLock("TRB",.f.)
	TRB->CLIENTE	:= cCodCli
	TRB->LOJA  		:= cLojaCli
	TRB->CNPJ   	:= cCnpj
	TRB->CLI_ENT	:= cCliEnt
	TRB->LOJ_ENT	:= cLojEnt
	TRB->CNPJENT	:= cCnpjEnt
	TRB->NUMPED		:= Strzero(Val(TRB->NUMPED),6)
	TRB->PRODUT		:= if(Alltrim(TRB->PAGTO)=="vale_presente", "***900", SearchPa8(TRB->PRODUT))
	TRB->DESCRI		:= if(!PA8->(Eof()).and.Left(TRB->PRODUT,3)<>"***", PA8->PA8_DESMP8, TRB->DESCRI)
	TRB->BLOQUEI	:= if(SA1->A1_MSBLQL=='1', .t., .f.)
	TRB->CONDPAG	:= CondPgto(aCondPag, TRB->PAGTO, Val(TRB->PARCELA))
	TRB->BANCO		:= if(Type("cParBan")="U", SA1->A1_BCO1   , " ") 			// cParBan Nao e' obrigatorio
	TRB->NATURE		:= if(Type("cParNat")="U", SA1->A1_NATUREZ, cParNat)
	TRB->ENTREG 	:= dDataBase
	TRB->VENDAS		:= SB1->B1_CODVEN
	TRB->CODTES		:= SB1->B1_TS //_cTes
	TRB->LOCPAD		:= SB1->B1_LOCPAD
	TRB->UNIDAD		:= SB1->B1_UM
	TRB->TOTITEM	:= ( Round(Val(TRB->QTDVEN) ,2) * Round(Val(TRB->PRCVEN)/100,2) )
	TRB->CODCAR		:= IIf(Alltrim(aRetBand[1]) == "AMEX", SubStr(Alltrim(TRB->CODCAR), 1, 15), SubStr(Alltrim(TRB->CODCAR), 1, 16))	
	TRB->BANDEI		:= Alltrim(aRetBand[1])
	TRB->PARCEL		:= Alltrim(cParcela)
	TRB->CODSEG		:= Alltrim(aRetBand[2])	
	TRB->VALIDA		:= Alltrim(TRB->VALIDA)
	TRB->CODAUT		:= Alltrim(TRB->CODAUT)
	TRB->MENNOTA	:= MakeMens(.F., TRB->PRODUT,SB1->B1_TIPO, Alltrim(TRB->DESCRI), Val(TRB->QTDVEN), Val(TRB->PRCVEN)/100, TRB->TOTITEM,TRB->CARTAO)
	TRB->IMPORT 	:= .f.
	MsUnlock()
	TRB->(DbSkip())
Enddo

/*
???????????????????????????????
?Valida a existencia do arquivo?
????????????????????????????????
*/

lRet:= iif( !File(cNome+GetDbExtension()),.f., .t.)
Return lRet
/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?VALFILE   ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Executa a validacao do arquivo                              ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/
Static Function Bandeira(cMen)

Local aRet := {}

If Upper(SubStr(Alltrim(cMen), 1, 1)) == "M"
	aAdd(aRet, "MASTERCARD")
	aAdd(aRet, SubStr(Alltrim(cMen), At("CS", Alltrim(cMen)) + 3, 4))	
ElseIf Upper(SubStr(Alltrim(cMen), 1, 1)) == "V"
	aAdd(aRet, "VISA")
	aAdd(aRet, SubStr(Alltrim(cMen), At("CS", Alltrim(cMen)) + 3, 4))	
ElseIf Upper(SubStr(Alltrim(cMen), 1, 1)) == "A"
	aAdd(aRet, "AMEX")
	aAdd(aRet, SubStr(Alltrim(cMen), At("CS", Alltrim(cMen)) + 3, 4))	
Else
	aAdd(aRet, "") 
	aAdd(aRet, "")	
EndIf

Return aRet

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?VALFILE   ? Autor ?Henio Brasil Claudino  ? Data ? 21.03.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Executa a validacao do arquivo                              ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function ValFile(cNome,cArqTxt,nHandle,cArqLog)

Local cNumPed	:= ''
Local cCnpjPed	:= ''
Local cNewAliq	:= ''
Local dEmissao 	:= ''
Local dEntrega 	:= ''
Local cErroTxt	:= ''
Local lSecond	:= .f.
Local lFatal	:= .f.
Local lReg		:= .t.
Local nReg		:= 0
Local nRegBad	:= 0

Local n
Local cIndexArq	:= Criatrab(Nil,.F.)

If !_lJob
	U_SetProc(2,TRB->(RecCount()),"Validando arquivo...")
EndIf

// MsgStop(" Concluida geracao arquivo TRB !")

DbSelectArea("TRB")
IndRegua("TRB",cIndexArq,"NUMPED",,,OemToAnsi("Montando Arquivo..."))
DbGoTop()

/*
??????????????????????
?Valida todo o arquivo?
???????????????????????
*/

nReg := 0
While TRB->(!Eof())
	
	lReg 		:= .t.
	cNumPed 	:= Alltrim(TRB->NUMPED)
	cCnpjPed 	:= Alltrim(TRB->CNPJ)
	
	/*
	???????????????????????????????????
	? Valida Codigo do Produto         ?
	????????????????????????????????????*/
	If Alltrim(TRB->PRODUT) == "***100"
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Codigo Produto nao encontrado."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????????????????????????????????????????????
	? Valida se o produto e' Kit e nao foi encontrado na tabela de De-Para     ?
	????????????????????????????????????????????????????????????????????????????
	*/
	
	If Alltrim(TRB->PRODUT) == '***200'
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Algum ERRO no Cadastro de Estruturas(Kits)."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????????????????????????????????????????????
	? Valida se o produto Servico tem valor informado no Cadastro de Produtos  ?
	????????????????????????????????????????????????????????????????????????????
	*/
	
	If Alltrim(TRB->PRODUT) == '***300'
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Servico/Mercadoria SEM valor no Cadastro de Produtos."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????????????????????????????????????????????
	? Valida se o produto Servico tem valor informado no Cadastro de Produtos  ?
	????????????????????????????????????????????????????????????????????????????*/
	If Alltrim(TRB->PRODUT) == '***400'
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Servico/Mercadoria sem TES no Cadastro de Produtos."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	??????????????????????????????????????????????????????????????????????????????
	? Valida se o produto tem possui o codigo do vendedor no Cadastro de Produtos ?
	???????????????????????????????????????????????????????????????????????????????*/
	If Alltrim(TRB->PRODUT) == '***500'
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Codigo de Vendedor em branco no Cadastro de Produtos."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????????????????????????????????????????????
	? Valida se o produto e' Vale Presente - Conceito de Desconto Bpag         ?
	????????????????????????????????????????????????????????????????????????????*/
	If Alltrim(TRB->PRODUT) == '***900'
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Produto Vale_Presente."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????
	? Valida Codigo do Cliente+Loja    ?
	????????????????????????????????????*/
	If Empty(TRB->CLIENTE) .or. Empty(TRB->LOJA)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Cnpj: "+cCnpjPed+" Sem Dados de Cliente e Loja, Cnpj nao encontrado."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	??????????????????????????????????????
	? Valida se o Cliente esta Bloqueado  ?
	???????????????????????????????????????
	*/
	
	If (TRB->BLOQUEI)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Cnpj: "+cCnpjPed+" Cliente Bloqueado para uso"
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????
	? Valida data de emissao       ?
	????????????????????????????????
	*/
	
	dEntrega 	:=  TRB->ENTREG
	dEmissao 	:=  ctod(Alltrim(TRB->EMISSA))
	If Empty(TRB->EMISSA) .or. Empty(TRB->ENTREG)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Sem Data de Emissao e Data de Entrega"
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
		
	Else
		
		/*
		???????????????????????????????
		? Valida limite da emissao     ?
		????????????????????????????????
		*/
		
		If dEmissao <= GetMv("MV_DATAFIS")
			cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Data de Emissao menor que data de Fechamento Fiscal"
			U_MakeTxt(nHandle,cArqLog,cErroTxt)
			lReg := .f.
		EndIf
		If dEntrega < dDataBase 		// .or. dEmissao > dDataBase
			cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Data de Entrega menor que a data base do sistema"
			U_MakeTxt(nHandle,cArqLog,cErroTxt)
			lReg := .f.
		EndIf
		
	EndIf
	/*
	???????????????????????????????????????????????????????????????????????????
	? Valida dados: Cond.Pagamento; Natureza e Codigo de Vendedor              ?
	????????????????????????????????????????????????????????????????????????????*/
	If Empty(TRB->CONDPAG)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Sem Condicao de Pagamento"
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	If Empty(TRB->NATURE)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Sem Natureza Financeira"
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	If Empty(TRB->VENDAS)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Sem Codigo de Vendedor no Produto"
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	
	/*
	???????????????????????????????????????????????
	?Valida se o Pedido Bpag ja foi importado	   ?
	????????????????????????????????????????????????*/
	
	/*
	Ajustes de código para atender Migração versão P12
	Uso de DbOrderNickName
	OTRS:2017103110001774
	*/
		
	DbSelectArea("SC5")
	DbOrderNickName("NUMPEDGAR")
	
	If DbSeek(xFilial("SC5")+cNumPed , .F.)
		cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Pedido j? importado no Protheus."
		U_MakeTxt(nHandle,cArqLog,cErroTxt)
		lReg := .f.
	Endif
	DbSetOrder(1)
	
	lSecond	:= .f.
	DbSelectArea("TRB")
	// nNumPed := Val(TRB->NUMPED)
	Do While TRB->(!Eof()) .And. cNumPed == Alltrim(TRB->NUMPED)
		
		/*
		???????????????????????????????????????????????
		?Valida Duplicidade de Pedidos no Arq. TXT     ?
		????????????????????????????????????????????????*/
		If lSecond .And. cNumPed == Alltrim(TRB->NUMPED)
			RecLock("TRB", .F.)
			DbDelete()
			MsUnLock()
			TRB->(DbSkip())
			Loop
		Endif
		/*
		???????????????????????????????????????????????
		?Valida o Codigo do TES se for # de KIT        ?
		????????????????????????????????????????????????*/
		If Left(TRB->PRODUT,2)<>"KT"
			If Empty(TRB->CODTES)
				cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Nao encontrou codigo do TES no Produto"
				U_MakeTxt(nHandle,cArqLog,cErroTxt)
				lReg := .f.
			Else
				/*
				???????????????????????????????????????????
				?Valida o TES, se nao existir gera Log     ?
				????????????????????????????????????????????*/
				DbSelectArea("SF4")
				DbSetOrder(1)
				If !dbSeek(xFilial("SF4")+TRB->CODTES ,.f.)
					lReg := .f.
				ElseIf Val(SF4->F4_CODIGO) < 501		// Valida o TES no Produto
					cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - TES invalido para Pedido de Venda"
					U_MakeTxt(nHandle,cArqLog,eErroTxt)
					lReg := .f.
				EndIf
				
			Endif
		Endif
		
		/*
		??????????????????????????????????????????????????????????????
		?Valida a Quantidade, Preco Unit e Vlr Total do item da NF    ?
		???????????????????????????????????????????????????????????????*/
		If Val(TRB->QTDVEN)==0 .or. Val(TRB->PRCVEN)==0 .or. TRB->TOTITEM==0
			cErroTxt := "- Arquivo de Importacao: "+cArqTxt+"  Pedido: "+cNumPed+" - Sem informacao de Quantidade ou Preco de Venda"
			U_MakeTxt(nHandle,cArqLog,cErroTxt)
			lReg := .f.
		Endif
		
		/*
		????????????????????????????????????????????????????????????
		?Verifica se o registro sera importado e grava informacoes  ?
		?????????????????????????????????????????????????????????????
		*/
		If lReg
			DbSelectArea("TRB")
			RecLock("TRB", .F.)
			TRB->IMPORT := .T.
			MsUnLock()
		Else
			
			/*
			???????????????????????????????????????
			?Aqui sei que todos Reg estao RUINS    ?
			????????????????????????????????????????
			*/
			
			nRegBad := nRegBad+1
			
		EndIf
		TRB->(DbSkip())
		If !_lJob
			U_AddProc(2)
		EndIf
		
		nReg 	:= nReg+1
		lSecond	:= .t.
	EndDo
	
EndDo

/*
???????????????????????????????????????????????????????????????????????
?Aqui invalido todo o Arquivo, caso nenhum dos registros for valido    ?
????????????????????????????????????????????????????????????????????????
*/

lFatal := iif(nReg == nRegBad, .t., .f.)
Return lFatal


/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Programa  ?IMPORTPV  ?Autor  ?Henio Brasil        ? Data ?  21/03/07   ???
????????????????????????????????????????????????????????????????????????????
???Desc.     ?Realiza a importacao da Nota Fiscal                         ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ? CertiSign Certificadora Digital S/A                        ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function ImportPV(cNome)

Local aCabPed	:= {}
Local aItemPed	:= {}
Local aItens 	:= {}
Local aAllPedido:= {}
Local aPed1Prd	:= {}
Local aPedPrd2	:= {}
Local aQtdTpPrd	:= {}
Local aMensPed	:= {}

Local lTudoOk	:= .t.
Local lGeraKit 	:= .f.
Local cCliEntreg:= ''
Local cLojEntreg:= ''

Local cTesSv 	:= "903" 		// Tes de Servico
Local cTesMr 	:= "502" 		// Tes de Mercadoria
Local cNumPed	:= cPrdPed	:= cMensPed	:= cMens := ''
Local cPrdDes	:= cLocPad	:= cTSaida	:= cUnid := ''
Local nQtdPed 	:= nQtdItem	:= nPosIt 	:= 1
Local nQtdVen  	:= nPrcVen  := nTotItem	:= 0.0
Local lEstruOn	:= GetMv("MV_CCPESTR")

Private nVlrParc:= 0.00			// totalizador Vlr Parcial
Private nVlrMerc:= 0.00			// Valores itens Mercadoria
Private nTotMerc:= 0.00			// Totalizador Vlr Mercadoria
If !_lJob
	U_SetProc(2,TRB->(RecCount()),"Importando arquivo...")
EndIf
// MsgStop(" Pque nao aparece a mensagem? Vai iniciar a Importacao !")

/*
?????????????????????????????????????????????????
?Ordena o arquivo de forma as notas de devolucao ?
?serem tratadas depois das Normais               ?
??????????????????????????????????????????????????*/
DbSelectArea("TRB")
DbGoTop()

nNumPed := Val(TRB->NUMPED)  		// consistir qdo trocar o No Pedido
Do While TRB->(!Eof())
	
	/*
	??????????????????????????????
	?Inicializa Variaveis de Data ?
	???????????????????????????????*/
	lGeraKit 	:= .f.
	nQtdItem 	:= nQtdPed  := 1
	dEntrega 	:= TRB->ENTREG
	nTotItem 	:= TRB->TOTITEM
	nQtdVen  	:= Val(TRB->QTDVEN)
	nPrcVen  	:= Val(TRB->PRCVEN)/100
	cNumPed	    := Alltrim(TRB->NUMPED)
	dEmissao 	:= ctod(Alltrim(TRB->EMISSA))
	cCliEntreg	:= iif(!Empty(TRB->CLI_ENT), TRB->CLI_ENT, TRB->CLIENTE)
	cLojEntreg	:= iif(!Empty(TRB->LOJ_ENT), TRB->LOJ_ENT, TRB->LOJA   )
	
	/*
	??????????????????????????????????????
	?Gera o Log na Tabela PA6             ?
	???????????????????????????????????????*/
	DbSelectArea("PA6")				// Ordem 1 - Cnpj / 2 - Razao / 3 - Cep
	DbSetOrder(2)
	lOpcAltera := (DbSeek(xFilial()+cNumPed , .f.))
	If TRB->(!Eof())
		RecLock("PA6", !lOpcAltera)					// 	Se nao encontrou sera .T.
		PA6->PA6_FILIAL		:= xFilial("PA6")      		//  PA6->PA6_FILIAL
		PA6->PA6_NUMPED 	:= TRB->NUMPED				//  PA6->PA6_NUMPED
		PA6->PA6_EMISSA 	:= dEmissao					//  PA6->PA6_EMISSA
		PA6->PA6_PRODUT		:= TRB->PRODUT  			//  PA6->PA6_PRODUT
		PA6->PA6_DESCRI		:= TRB->DESCRI 				//  PA6->PA6_DESCRI
		PA6->PA6_QTDVEN		:= nQtdVen			 		//  PA6->PA6_QTDVEN
		PA6->PA6_PRCVEN		:= nPrcVen					//  PA6->PA6_PRCVEN
		PA6->PA6_ENTREG		:= dEntrega					//  PA6->PA6_ENTREG
		PA6->PA6_CNPJ   	:= TRB->CNPJ   				//  PA6->PA6_CNPJ
		PA6->PA6_CLIENT		:= TRB->CLIENTE				// 	SA1 Codigo do Cliente
		PA6->PA6_LOJA  		:= TRB->LOJA 				// 	Loja do Cliente
		PA6->PA6_CONDPG		:= TRB->CONDPAG          	// 	SE4 Condicao de Pgto
		PA6->PA6_VENDAS		:= TRB->VENDAS           	// 	SA3 Codigo Vendedor
		PA6->PA6_TES   		:= TRB->CODTES 	     	   	// 	SF4 Codigo do TES
		PA6->PA6_CARTAO 	:= TRB->CARTAO 			//  PA6->PA6_CARTAO
		PA6->PA6_PAGTO  	:= TRB->PAGTO  			//  PA6->PA6_PAGTO
		PA6->PA6_PARCEL 	:= TRB->PARCELA			//  PA6->PA6_PARCEL
		PA6->PA6_CNPJ2   	:= TRB->CNPJENT			//  Cnpj do Cliente Entrega
		PA6->PA6_CLENTR		:= TRB->CLI_ENT				// 	SA1 Codigo do Cliente de Entrega
		PA6->PA6_LJENTR  	:= TRB->LOJ_ENT			// 	Loja do Cliente de Entrega
		PA6->PA6_IMPORT 	:= iif(TRB->IMPORT==.t., '1', '2') 		//  PA6->PA6_IMPORT
		PA6->PA6_DATIMP		:= date() 					//  PA6->PA6_DATIMP
		MsUnLock()
	Endif
	
	/*
	?????????????????????????????????????????????
	?Valida se realizara a importacao do registro?
	??????????????????????????????????????????????*/
	DbSelectArea("TRB")
	If !(TRB->IMPORT)
		lTudoOk := .f.
		TRB->(DbSkip())
		Loop
	EndIf
	
	/*
	????????????????????????
	?Inicializa as variaveis?
	?????????????????????????*/
	aCabPed		:= {}
	aAllPedido	:= {}
	aPedPrd1	:= {}
	aPedPrd2	:= {}
	aQtdTpPrd  	:= {}
	aMensPed   	:= {}
	
	/*
	???????????????????????????????????????????????????
	?Tratamento da Estrutura Produto para ver Servicos ?
	?Obs: Nao ha perigo de misturar =>Indice 1 - SG1   ?
	????????????????????????????????????????????????????
	*/
	
	If lEstruOn
		nVlrParc := nTotMerc := 0.0           		// nPrcVen
		DbSelectArea("SG1")
		DbSetOrder(1)
		If SG1->(DbSeek(xFilial("SG1")+Alltrim(TRB->PRODUT) ,.f. ))
			While SG1->G1_FILIAL == xFilial("SG1") .and. Alltrim(SG1->G1_COD) == Alltrim(TRB->PRODUT)
				lServico:= (Posicione("SB1", 1, xFilial("SB1")+Alltrim(SG1->G1_COMP), "B1_TIPO")<>"MR")
				
				/*
				?????????????????????????????????????????????????????????????????????????????????????
				?Posiciona no SB1 para buscar Vlr do Servico e demais dados do Produto, nao ha perigo?
				?de vir valor 0.0 pois ja foi consistido no SearchPA8()                              ?
				??????????????????????????????????????????????????????????????????????????????????????
				*/
				
				If lServico
					cTesSv := if(!Empty(SB1->B1_TS), SB1->B1_TS, cTesSr)
					Aadd(aPedPrd1 , {SG1->G1_COD,SG1->G1_COMP,SB1->B1_TIPO,SB1->B1_LOCPAD,SB1->B1_UM, ;
					cTesSv,SB1->B1_DESC,SB1->B1_PRV1,0.0,0.0,0.0 })
					k:= Len(aPedPrd1)
					CalcKit(aPedPrd1, nTotItem, lServico, .F.)              			     // aPedPrd1[k,08], aPedPrd1[k,10]
					cMens:= MakeMens(.T., aPedPrd1[k,02], aPedPrd1[k,03], aPedPrd1[k,07], k, aPedPrd1[k,11], aPedPrd1[k,11], TRB->CARTAO)
					
				Else
					cTesMr := if(!Empty(SB1->B1_TS), SB1->B1_TS, cTesMr)
					Aadd(aPedPrd2 , {SG1->G1_COD,SG1->G1_COMP,SB1->B1_TIPO,SB1->B1_LOCPAD,SB1->B1_UM, ;
					cTesMr,SB1->B1_DESC,SB1->B1_PRV1,0.0,0.0,0.0 })
					k:= Len(aPedPrd2)
					CalcKit(aPedPrd2, nTotItem, lServico, .F.)
					cMens:= MakeMens(.T., aPedPrd2[k,02], aPedPrd2[k,03], aPedPrd2[k,07], k, aPedPrd2[k,11], aPedPrd2[k,11], TRB->CARTAO)
					
				Endif
				
				// Alimenta o array de Mensagem - Desconsiderado em 25/05/2007
				
				If lServico
					If Len(aMensPed)==0
						Aadd(aMensPed, cMens)
					Else
						aMensPed[1] := cMens
					Endif
					
				Else
					Aadd(aMensPed, cMens)
				Endif
				SG1->(DbSkip())
			Enddo
			
			If Len(aPedPrd1)<>0 .and. Len(aPedPrd2)==0
				Aadd(aAllPedido, aPedPrd1)
				Aadd(aQtdTpPrd, Len(aPedPrd1))
			Endif
			If Len(aPedPrd2)<>0 .and. Len(aPedPrd1)==0
				Aadd(aAllPedido, aPedPrd2)
				Aadd(aQtdTpPrd, Len(aPedPrd2))
				
			Endif
			
			If Len(aPedPrd1)<>0 .and. Len(aPedPrd2)<>0
				aAllPedido	:= {aPedPrd1, aPedPrd2}
				CalcKit(aPedPrd2, nTotItem, lServico, .T.)
				Aadd(aQtdTpPrd, Len(aPedPrd1))
				Aadd(aQtdTpPrd, Len(aPedPrd2))
			Endif
			
			nQtdPed  := Len(aQtdTpPrd)
			lGeraKit := .t.
		Else
			
			
		Endif
		
	Endif
	
	/*
	????????????????????
	?Posiciona o Cliente?
	?????????????????????
	*/
	
	DbSelectArea("SA1")
	SA1->(dbSetOrder(1))								//	'01'
	If !SA1->(DbSeek(xFilial("SA1")+Alltrim(TRB->CLIENTE)+TRB->LOJA,.f. ))
		lTudoOk := .f.
		TRB->(DbSkip())
		Loop
	EndIf
	
	/*
	??????????????????????????????????????
	?Monta o Cabecalho do Pedido de Vendas?
	???????????????????????????????????????
	*/
	
	For m:=1 to nQtdPed
		aItens 	:= {}
		aItemPed	:= {} 				// Mudar aqui o Array 	aMensPed
		cMensPed	:= iif(lGeraKit, Alltrim(aMensPed[m]), Alltrim(TRB->MENNOTA))
		aCabPed 	:= {{"C5_FILIAL"	,xFilial("SC5")  	,Nil},;
		{"C5_TIPO"   	,'N'         		,Nil},; 	// Tipo de pedido
		{"C5_CLIENTE"	,TRB->CLIENTE	  	,Nil},; 	// Codigo do cliente
		{"C5_LOJACLI"	,TRB->LOJA   	  	,Nil},; 	// Loja do cliente
		{"C5_TIPOCLI"	,SA1->A1_TIPO		,Nil},; 	// Tipo de Cliente
		{"C5_VEND1"  	,TRB->VENDAS		,Nil},; 	// Codigo do Vendedor	B1_VEND1
		{"C5_XNATURE"	,TRB->NATURE		,Nil},; 	// Codigo da Natureza
		{"C5_CONDPAG"	,TRB->CONDPAG 		,Nil},; 	// Codigo da Cond. Pagamento 	TRB->CONDPAG
		{"C5_BANCO"  	,TRB->BANCO 		,Nil},; 	// Codigo do Banco
		{"C5_CLIENT" 	,cCliEntreg		   	,'.T.'},; 	// Codigo do cliente
		{"C5_LOJAENT"	,cLojEntreg	  	  	,'.T.'},; 	// Loja para entrada
		{"C5_EMISSAO"	,dEmissao			,Nil},; 	// Data de emissao
		{"C5_TIPLIB" 	,'2'  		     	,Nil},; 	// Tipo de Liberacao 1 - Item 2 - Pedido (x)
		{"C5_MOEDA"  	,1					,Nil},; 	// Moeda
		{"C5_CHVBPAG"	,cNumPed     		,Nil},; 	// No do Pedido Bpag
		{"C5_MENNOTA"	,cMensPed			,Nil},; 	// Mensagem do Pedido
		{"C5_TPCARGA"	,'2'        		,Nil},;		// Tipo de Carga		*/
		{"C5_XCARTAO"	,TRB->CODCAR  		,Nil},;		// Numero do Cartao		*/		
		{"C5_XBANDEI"	,TRB->BANDEI  		,Nil},;		// Nome da Bandeira		*/				
		{"C5_XCODSEG"	,TRB->CODSEG  		,Nil},;		// Codigo Seguraca		*/						
		{"C5_XPARCEL"	,TRB->PARCEL  		,Nil},;		// Parcela	         	*/								
		{"C5_XVALIDA"	,TRB->VALIDA  		,Nil},;		// Validacao		    */										
		{"C5_XCODAUT"	,TRB->CODAUT  		,Nil}} 		// Codigo Autenticacao		*/												
		
		/*
		?????????????????????????????????????????????????????????????????????????
		?Ajusta a variavel Qtd Itens do Pedido pelo array do tipo de Produto Kit ?
		??????????????????????????????????????????????????????????????????????????
		*/
		
		nQtdItem := If(lGeraKit, aQtdTpPrd[m], nQtdItem)
		For n:=1 to nQtdItem
			cPrdPed		:= iif(lGeraKit, Alltrim(aAllPedido[m,n,02])	, Alltrim(TRB->PRODUT))
			cPrdDes  	:= iif(lGeraKit, Alltrim(aAllPedido[m,n,07])	, Alltrim(TRB->DESCRI))
			cLocPad  	:= iif(lGeraKit, aAllPedido[m,n,04]			, Alltrim(TRB->LOCPAD))
			cUnid    	:= iif(lGeraKit, aAllPedido[m,n,05]			, Alltrim(TRB->UNIDAD))
			cTSaida  	:= iif(lGeraKit, aAllPedido[m,n,06]			, Alltrim(TRB->CODTES))
			nPrcVen  	:= iif(lGeraKit, Round(aAllPedido[m,n,10],4)	, nPrcVen)
			nTotItem  	:= iif(lGeraKit, Round(aAllPedido[m,n,10],2)	, nTotItem)
			
			
			_cProduto 	:= cPrdPed
			_cTipoCli	:= SA1->A1_TIPO
			_cEstCli	:= SA1->A1_EST
			
			_cTes 		:= U_VerTes(_cProduto,_cTipoCli,_cEstCli,cTSaida)
			
			If Empty(_cTes)
				_cTes:= cTSaida
			Endif
			
			aItens 	:= {{"C6_FILIAL"	,xFilial("SC6")		,Nil},;
			{"C6_ITEM"		,Strzero(n,2)		,Nil},;
			{"C6_PRODUTO"	,cPrdPed			,Nil},;
			{"C6_LOCAL"		,cLocPad    		,Nil},;			// SB1->B1_LOCPAD
			{"C6_UM"		,cUnid		 		,Nil},;			// SB1->B1_UM
			{"C6_TES"		,_cTes				,NIL},;
			{"C6_CLI"		,TRB->CLIENTE  		,NIL},;
			{"C6_LOJA"		,TRB->LOJA     		,NIL},;
			{"C6_ENTREG"	,dEntrega	 		,NIL},;
			{"C6_DESCRI"	,cPrdDes	  		,NIL},;
			{"C6_QTDVEN"	,nQtdVen			,NIL},;
			{"C6_PRCVEN"	,nPrcVen			,NIL},;
			{"C6_VALOR"		,nTotItem 			,NIL}}
			
			Aadd(aItemPed,aItens)
		Next
		
		/*
		?????????????????????????????????????????
		?Executa MsExecAuto da NF - Faturamento  ?
		??????????????????????????????????????????
		*/
		
		lMsErroAuto := .T.
		MSExecAuto({|x,y,z|Mata410(x,y,z)},aCabPed, aItemPed, 3)
		
		If lMsErroAuto
			MostraErro('SYSTEM','ErroImp.log')
			
		EndIf
		
	Next
	TRB->(DbSkip())
	If !_lJob
		U_AddProc(2)
	EndIf
	
EndDo

Return(lTudoOk)


/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?CHECKCGC  ? Autor ?Henio Brasil Claudino  ? Data ? 19.04.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Valida a formatacao do Cnpj ou Cpf enviados no arquivo Txt  ???
???          ?                                                            ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function CheckCGC(cCnpj)

/*
?????????????????????????????????????????????????????????
?Valida a formatacao do Cnpj do Cliente vindo no Txt     ?
??????????????????????????????????????????????????????????
*/

Local cCnpjCpf:= cCnpj

If !Empty(cCnpj)
	
	If Len(Alltrim(cCnpj))<11
		cCnpjCpf:= Strzero(Val(cCnpj),11)
		
	ElseIf Len(Alltrim(cCnpj))>11 .and. Len(Alltrim(cCnpj))<=14
		cCnpjCpf:= Strzero(Val(cCnpj),14)
	EndIf
Endif
Return(cCnpjCpf)

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?SEARCHPA8 ? Autor ?Henio Brasil Claudino  ? Data ? 09.04.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Pesquisa codigo Bpag para valida-lo.                        ???
???          ?Verifica se o Produto e' Kit para valida-lo                 ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function SearchPa8(cPrdBpag) 			// SearchPa8(cProd,cDescri)

Local cCodMp8	:= ''
Local cDesMp8	:= '' 	// nao precisa!!!
Local aAmbTrb	:= GetArea()
Local nRegSb1	:= SB1->(Recno())
Local lEstruOn	:= GetMv("MV_CCPESTR")
Local lExistKit	:= .f.

DbSelectArea("PA8")
DbSetOrder(1)
cCodMp8	:= if(DbSeek(xFilial("PA8")+cPrdBpag, .f.), Alltrim(PA8_CODMP8), '' )
cDesMp8	:= if(DbSeek(xFilial("PA8")+cPrdBpag, .f.), Alltrim(PA8_DESMP8), '' )

If PA8->(Eof())
	DbSelectArea("SB1")
	DbSetOrder(1)
	
	lProdOk := DbSeek(xFilial("SB1")+cPrdBpag, .f.)
	cCodMp8	:= if(lProdOk , cPrdBpag, '***100' )
	nRegSb1	:= Recno()
	
	/*
	??????????????????????????????????????????????????????????????????????
	? Como nao encontrou no De-Para, este produto vai original Pedido,    ?
	? logo precisa saber se ele tem Preco de Venda cadastrado             ?
	???????????????????????????????????????????????????????????????????????
	*/
	
	cCodMp8 	:= if(lProdOk .and. SB1->B1_PRV1==0  	  , '***300', cCodMp8)
	cCodMp8 	:= if(lProdOk .and. Empty(SB1->B1_TS)	  , '***400', cCodMp8)
	cCodMp8 	:= if(lProdOk .and. Empty(SB1->B1_CODVEN) , '***500', cCodMp8)
	RestArea(aAmbTrb)
	Return(cCodMp8)
	
Else
	/*
	??????????????????????????????????????????????????????????????????????
	? Posiciona no SB1 para buscar outros dados !                         ?
	???????????????????????????????????????????????????????????????????????
	*/
	DbSelectArea("SB1")
	DbSetOrder(1)
	DbSeek(xFilial("SB1")+cCodMp8 ,.f.)
	nRegSb1	:= Recno()
Endif

/*
??????????????????????????????????????????????????????????????????????
? Verifica se e' Kit para tratar Validacoes no Cad. Estrutura         ?
???????????????????????????????????????????????????????????????????????
*/

lExistKit := if(Left(cCodMp8,3) <> '***' .and. Left(cCodMp8,2)=="KT" .and. SB1->B1_TIPO=="KT", .t., .f.)

/*
??????????????????????????????????????????????????????????????????????
? Verifica se o Kit tem valor venda para o item Servico e Mercadoria  ?
? Valor do Produto-Mercadoria devera ser encontrado pela diferenca    ?
???????????????????????????????????????????????????????????????????????*/
If lEstruOn .and. lExistKit
	DbSelectArea("SG1")
	DbSetOrder(1)
	If SG1->(DbSeek(xFilial("SG1")+cCodMp8 ,.f. ))                       // cCodMp8
		While SG1->G1_FILIAL == xFilial("SG1") .and. Alltrim(SG1->G1_COD) == cCodMp8
			DbSelectArea("SB1")
			lProdOk 	:= DbSeek(xFilial("SB1")+Alltrim(SG1->G1_COMP) , .f.)
			cCodMp8	:= if(!lProdOk		 					  , '***200', cCodMp8)
			cCodMp8 	:= if(lProdOk .and. SB1->B1_PRV1==0  	  , '***300', cCodMp8)
			cCodMp8 	:= if(lProdOk .and. Empty(SB1->B1_TS)	  , '***400', cCodMp8)
			cCodMp8 	:= if(lProdOk .and. Empty(SB1->B1_CODVEN), '***500', cCodMp8)
			// Precisa ver se nao vai desposicionar aqui !
			SG1->(DbSkip())
		Enddo
		DbSelectArea("SB1")
		DbGoto(nRegSb1) 			 // para garantir o posicionamento no SB1 - Tipo KT
	Else
		// Algum erro ocorreu na consulta a Estrutura, mas ja estava posicionado no SB1
		cCodMp8 := if(SB1->B1_PRV1==0 .and. SB1->B1_TIPO<>"MR", '***200', cCodMp8)
	Endif
	
Endif

RestArea(aAmbTrb)
Return(cCodMp8)


/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?CONDPGTO  ? Autor ?Henio Brasil Claudino  ? Data ? 09.04.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Processa a Condicao de Pagamento do arquivo de Pedidos      ???
???          ?Trata o No. de Parcelas da Condicao Pgto, caso der Erro     ???
???          ?retorna 000 - Avista                                        ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function CondPgto(aCondPag, cPgto, nParcela)

Local lAprazo	:= iif( Left(cPgto,6)=="cartao", .t., .f.)
// Local nParcela 	:= iif(nParcela==0, 0, StrZero(nParcela,2)) 		// Este nao precisa
Local nPosCond	:= Ascan(aCondPag, { |x|  x[1] == nParcela }) 			// Ascan(aCondPag, nParcela)
Local cCondicao	:= If(nPosCond==0, "000", aCondPag[nPosCond,2])

cCondicao  	:= iif(lAprazo .and. nPosCond==0, cCondicao, aCondPag[nPosCond,2])
Return(cCondicao)

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?MAKEMENS  ? Autor ?Henio Brasil Claudino  ? Data ? 09.04.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Gera Mensagem do pedido, para atualizar o C5_MENNOTA        ???
???          ?                                                            ???
???Manutencao?Alterada a funcao para ignorar conteudo da mensagem         ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
Jogar todo este tratamento em Parametros para tirar do fonte!!
*/

Static Function MakeMens(lKit,cProd,cTipoProd,cDescri,nQtdVen,nPrcVen,nValor,nCartao)

Local cPedBpag 	:= Alltrim(TRB->NUMPED)
Local cTipoProd := If(Type("cTipoProd")="U", SB1->B1_TIPO, cTipoProd)
Local cMensagem := ''
Local aMensPed  := {}
Local cCartao   := ''

/*
??????????????????????????????????????????????????????????????????????
? Trata o Nome da Operadora de Cartao de Credito                      ?
???????????????????????????????????????????????????????????????????????*/
cCartao 	:= iif( nCartao=='1', "Amex"		, cCartao)
cCartao 	:= iif( nCartao=='2', "Mastercard"	, cCartao)
cCartao 	:= iif( nCartao=='3', "Visa"		, cCartao)
cCartao 	:= iif( nCartao=='4', "Outros"		, cCartao)

/*
??????????????????????????????????????????????????????????????????????
? Valida se o produto ja' nao e' Log, ou se o mesmo nao e' Kit        ?
???????????????????????????????????????????????????????????????????????*/
If !lKit
	If Left(TRB->PRODUT,3)=="***" .Or. SB1->B1_TIPO=="KT"
		Return(" ")
	Endif
Endif

/*
??????????????????????????????????????????????????????????????????????
? Processo de Montagem de Mensagem, para SC5 com base no Produto      ?
???????????????????????????????????????????????????????????????????????*/
If cTipoProd <> "MR"
	cMensagem:= AllTrim(cDescri) + ";"
	cMensagem+= Space(1) + "Qtde:"
	cMensagem+= Space(1) + AllTrim(Transform(nQtdVen, "@E 999,999,999.99")) + ";"
	cMensagem+= Space(1) + "Pre?o Unit?rio:"
	cMensagem+= Space(1) + AllTrim(Transform(nPrcVen, "@E 999,999,999.99")) + ";"
	cMensagem+= Space(1) + "Valor Total:"
	cMensagem+= Space(1) + AllTrim(Transform(nValor,  "@E 9,999,999,999.99")) + ";"
	cMensagem+= Space(1) + "NF Liquidada - Pedido Bpag: " + cPedBpag
Else
	cMensagem:= "NF Liquidada - Pedido Bpag: " + cPedBpag 			// + " Pgto Cartao: " + cCartao
Endif
If nCartao<>' '
	cMensagem+= "Pgto Cartao: " + cCartao
Endif
Return(cMensagem)

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Funcao    ?CALCKIT   ? Autor ?Henio Brasil Claudino  ? Data ? 15.04.07 ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ?Calcula Proporcionalidade dos itens qdo tiver for KIT       ???
????????????????????????????????????????????????????????????????????????????
???Uso       ?CertiSign Certificadora Digital S/A                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
Static Function CalcKit(aProdPed,nQtdTpPrd,nTotItem,lServ,lCalcProp)
aPedPrd1[Len(aPedPrd1),09]:= 0.0 	% proporcionalidade para regra de 3
aPedPrd1[Len(aPedPrd1),10]:= 0.0 	Vlr Parcial a ser gravado no Pedido
*/

Static Function CalcKit(aProdPed,nTotItem,lServ,lCalcProp)


/*
??????????????????????????????????????????????????????????????????????
?Calcula a Proporcionalidade entre os produtos MR                     ?
???????????????????????????????????????????????????????????????????????*/
If lCalcProp
	// Verifica se existe apenas 1 Mercadoria
	If Len(aProdPed) == 1
		aProdPed[1 ,09]	:= 100.0 								// % 	aProdPed[nPosMR,09]
		aProdPed[1 ,10]	:= nVlrMerc                       		// Vlr Parcial Real
	Else
		// Regra de 3 para descobrir a proporcionalidade
		For j:=1 to Len(aProdPed)                     			// 1 to Len()
			aProdPed[j,09]:= aProdPed[j,08]/nTotMerc        	// %
			aProdPed[j,10]:= nVlrMerc*aProdPed[j,09]        	// Vlr Parcial Real
			aProdPed[j,11]:= aProdPed[j,11] + aProdPed[j,10]
		Next
	Endif
Endif
/*
??????????????????????????????????????????????????????????????????????
?Se for Servico, somar os totais dos produtos sem considerar Proporcao?
???????????????????????????????????????????????????????????????????????*/
j:= Len(aProdPed)

If lServ .and. !lCalcProp
	nVlrParc  := nVlrParc + aProdPed[j,08]
	nVlrMerc  := nTotItem - nVlrParc
	nVlrMerc  := if(nVlrMerc < 0, 1, nVlrMerc)
	aProdPed[j,09]:= 100.0 			// %
	aProdPed[j,10]:= SB1->B1_PRV1      // Vlr Parcial
	aProdPed[j,11]:= nVlrParc
ElseIf !lCalcProp
	nTotMerc  := nTotMerc + aProdPed[j,08]
	aProdPed[j,09]:= 100.0
	aProdPed[j,10]:= SB1->B1_PRV1
	aProdPed[j,11]:= SB1->B1_PRV1
Endif

Return

/*/
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Fun??o    ?VALIDPERG ? Autor ? AP5 IDE            ? Data ?  19/04/02   ???
????????????????????????????????????????????????????????????????????????????
???Descri??o ? Verifica a existencia das perguntas criando-as caso seja   ???
???          ? necessario                                                 ???
????????????????????????????????????????????????????????????????????????????
???Uso       ? Programa principal                                         ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
/*/

Static Function ValidPerg(cPerg)

Local _sAlias := Alias()
Local aRegs := {}
Local i,j

dbSelectArea("SX1")
dbSetOrder(1)
cPerg := PADR(cPerg,Len(X1_GRUPO))

// Grupo/Ordem/Pergunta/Variavel/Tipo/Tamanho/Decimal/Presel/GSC/Valid/Var01/Def01/Cnt01/Var02/Def02/Cnt02/Var03/Def03/Cnt03/Var04/Def04/Cnt04/Var05/Def05/Cnt05

aAdd(aRegs,{cPerg,"01","Codigo natureza    ?","Codigo Natureza    ?","Codigo natureza    ?","mv_ch1","C",10,0,0,"G","","mv_par01","","","","","","","","","","","","","","","","","","","","","","","","","SED",""})
aAdd(aRegs,{cPerg,"02","Caminho Ped. NEW   ?","Caminho Ped. Novos ?","Caminho Ped. Novos ?","mv_ch2","C",40,0,0,"G","","mv_par02","","","","","","","","","","","","","","","","","","","","","","","","","",""})
aAdd(aRegs,{cPerg,"03","Caminho Ped. PEND  ?","Caminho Ped. Incons?","Caminho Ped. Incons?","mv_ch3","C",40,0,0,"G","","mv_par03","","","","","","","","","","","","","","","","","","","","","","","","","",""})
aAdd(aRegs,{cPerg,"04","Caminho Ped. PROCD ?","Caminho Backup Ped.?","Caminho Backup Ped.?","mv_ch4","C",40,0,0,"G","","mv_par04","","","","","","","","","","","","","","","","","","","","","","","","","",""})
aAdd(aRegs,{cPerg,"05","Caminho LOG        ?","Caminho Log trans. ?","Caminho Log trans. ?","mv_ch5","C",40,0,0,"G","","mv_par05","","","","","","","","","","","","","","","","","","","","","","","","","",""})

For i := 1 to Len(aRegs)
	If !dbSeek(cPerg+aRegs[i,2])
		RecLock("SX1",.T.)
		For j:=1 to FCount()
			If j <= Len(aRegs[i])
				FieldPut(j,aRegs[i,j])
			Endif
		Next
		MsUnlock()
	Endif
Next

dbSelectArea(_sAlias)

Return

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Programa  ?ValidPar  ?Autor  ?Daniel Franciulli   ? Data ?  29/06/09   ???
????????????????????????????????????????????????????????????????????????????
???Desc.     ?Cria os parametros utilizados pela rotina no SX6            ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

Static Function ValidPar()

Local _aParam := {}

aAdd(_aParam,{"MV_XUFCSUB","C","Indica quais UF`s sofrerao tratameto de substitui","cao tributaria na rotina de EDI da Certisign","","SP"})
aAdd(_aParam,{"MV_XTPCSUB","C","Indica quais tipos de produtos sofrerao tratament","o de subst. tribu. na rotina de EDI da Certi","sign","MR"})

For _x:=1 to len(_aParam)
	DbSelectArea("SX6")
	DbSetOrder(1)
	If !DbSeek("  " + _aParam[_x][1])
		RecLock("SX6",.T.)
		SX6->X6_VAR     := _aParam[_x][1]
		SX6->X6_TIPO    := _aParam[_x][2]
		SX6->X6_DESCRIC := _aParam[_x][3]
		SX6->X6_DESC1   := _aParam[_x][4]
		SX6->X6_DESC2   := _aParam[_x][5]
		SX6->X6_CONTEUD := _aParam[_x][6]
		MsUnlock()
	EndIf
Next

Return()

/*
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???Programa  ?VerTes    ?Autor  ?Daniel Franciulli   ? Data ?  07/07/09   ???
????????????????????????????????????????????????????????????????????????????
???Desc.     ?Busca o tipo de sa?da correto                               ???
????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
*/

User Function VerTes(_cProduto,_cTipoCli,_cEstCli,cTSaida)

/*
Incluido por Daniel em 27/06/2009 para tratamento da substituicao tributaria conforme email abaixo:

Conversei com o Alexandre Nasser e ele pediu para eu te passar as informa??es referente a melhoria, abaixo segue os dois itens:

1 - Tratamento de Substitui??o Tribut?ria: Conforme Convernio firmado no pela Secret?ria da receita Estadusl de SP, onde toda a venda para cliente
final onde o ICMS c/ Substit Tribut?ria na entrada n?o dever? ser? calculado na nota fiscal de saida. Com isso deveremos fazer tratamento para
o fonte CCDEDI03.PRW que dever? fazer um pr? sele??o quanto a TES a ser utilizada no caso acima citado, utilizando a seguinte regra:
a - Estado da Uni?o no cadastro do cliente
b - Tipo do Cliente
c - CNPJ
d - Incr. Estadual
e - Parametro de MV_XCCSUBST --> Tipo "C" - Descri??o: Estados que fazem parte do Conv?nio de Substitui??o  Tribut?ria (Substituidos) - Con
teudo:"SP"
f - Tratamento somente poder? ser feito para os produtos e n?o poder? ser feito para os servi?os, lista de produtos a serem tratados:
-->MR010002
-->MR010001
-->MR010101
-->MR030011
-->MR020001
-->MR020005
-->MR020009
-->MR030001
-->MR030010
Esse tratamento deve-se a importa??o dos pedidos gerados pelo site da Certisign, no fonte acima citado no assunto;
2 - Cria??o de parametro para defini??o de Local de importa??o de arquivos (SX1), pois o programa teve como defini??o inicial o drive C: da maquina
do usu?rio e conforme solicita??o da Sra. Susana Taboas dever? ser selecionado a partiir do servidor Sol, drive "I" de acordo com o usu?rio exe
mplo: Ivan Carrocieri.

*/

_cTipo := Substr(_cProduto,1,2)

If _cTipo $ GetMV("MV_XTPCSUB")											// Tipo de produtos que entram no tratamento da ST
	If _cTipoCli="F" .and. _cEstCli$GetMV("MV_XUFCSUB")         		// UF de cliente que entram no tratamento da ST
		_cTes := Posicione("SB1",1,xFilial("SB1")+_cProduto,"B1_XTSST")
	ElseIf !(_cEstCli$GetMV("MV_XUFCSUB")) .and. (Empty(SA1->A1_INSCR) .or. Substr(SA1->A1_INSCR,1,5)=="ISENT")
		_cTes := Posicione("SB1",1,xFilial("SB1")+_cProduto,"B1_XTSST2")
	Else
		_cTes := Posicione("SB1",1,xFilial("SB1")+_cProduto,"B1_TS")
	Endif
Else
	_cTes := Posicione("SB1",1,xFilial("SB1")+_cProduto,"B1_TS")
Endif

_cTes := Iif(Empty(_cTes),cTSaida,_cTes)

Return(_cTes)